<html><head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sprintf/1.1.2/sprintf.min.js"></script>
<style>
body {
  font-family: sans-serif;
}
.led {
    height: 25px;
    width: 25px;
    background-color: #fff;
    border-radius: 50%;
    display: inline-block;
    vertical-align: middle;
}

#display {
    border: 1px solid;
    vertical-align: middle;
}
input.narrow {
  width: 12em;
}
</style>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head><body>
<h1>Clock rate</h1>

<br>
<table>
<tr><td>Instantaneous&nbsp;</td><td align=right><span id='last'></span></td><td>ppm</td><td><span id='lastsecs'></span></td><td>Seconds per day</td></tr>
<tr><td>Minute</td><td align=right><span id='minute'></span></td><td>ppm</td><td><span id='minutesecs'></span></td><td>Seconds per day</td></tr>
<tr><td>Hour</td><td align=right><span id='hour'></span></td><td>ppm</td><td><span id='hoursecs'></span></td><td>Seconds per day</td></tr>
<tr><td>Temperature</td><td align=right><span id='temp'>-</span></td><td>F</td></tr>
<tr><td>CPU Rate Error</td><td align=right><span id='rate'>-</span></td><td>ppm</td></tr>
</table>
<div id="minute_chart" style="height:400px; width:100%"></div>
<div id="hour_chart" style="height: 400px; width:100%"></div>
<div id="week_chart" style="height: 400px; width:100%"></div>
<div id="ntp_chart" style="height: 400px; width:100%"></div>
<script>

function leftFillNum(num, width){
  return num
    .toString()
    .padStart(width,0)
}

var chartNtp;
var chartDataNtp;
var lastNtp = 0;
var sampleNtp = 0;
var chartWeek;
var chartDataWeek;
var lastWeek = 0;
var sampleWeek = 0;
var chartHour;
var chartDataHour;
var lastHour = 0;
var sampleHour = 0;
var chart;
var chartData;
var last = 0;

var temperature;

function rateInPpm(rate) {
  return rate / ((1 << 30) / 250000);
}

function redrawWeek() {
        var options = {
          title: 'Average tick error over previous hour',
          series: {
            0: {targetAxisIndex: 0},
            1: {targetAxisIndex: 1}
          },
          vAxes: {
            // Adds titles to each axis.
            0: {title: 'Tick error (ppm)'},
            1: {title: 'Temperature (F)'}
          },
          hAxis: {
            title: 'Time'
          },
          legend: {
            position: 'none',
          },
          backgroundColor: '#f1f8e9'
        };

  if (chartDataWeek.getNumberOfRows() > 0) {
    chartWeek.clearChart();
    chartWeek.draw(chartDataWeek, options);
  }
}

function redrawNtp() {
        var options = {
          title: 'Average CPU Clock error',
          hAxis: {
            title: 'Time'
          },
          vAxis: {
            title: 'Clock error (ppm)'
          },
          legend: {
            position: 'none',
          },
          backgroundColor: '#f1f8e9'
        };

  if (chartDataNtp.getNumberOfRows() > 0) {
    chartNtp.clearChart();
    chartNtp.draw(chartDataNtp, options);
  }
}

function redrawHour() {
        var options = {
          title: 'Average tick error over previous minute',
          hAxis: {
            title: 'Time'
          },
          vAxis: {
            title: 'Tick error (ppm)'
          },
          legend: {
            position: 'none',
          },
          backgroundColor: '#f1f8e9'
        };

  if (chartDataHour.getNumberOfRows() > 0) {
    chartHour.clearChart();
    chartHour.draw(chartDataHour, options);
  }
}

function redraw() {
        var options = {
          title: 'Instantaneous tick error over previous tick',
          hAxis: {
            title: 'Time'
          },
          vAxis: {
            title: 'Tick error (ppm)'
          },
          legend: {
            position: 'none',
          },
          backgroundColor: '#f1f8e9'
        };

  if (chartData.getNumberOfRows() > 0) {
    chart.clearChart();
    chart.draw(chartData, options);
  }
}

window.onresize = function() {
  redraw();
  redrawHour();
  redrawWeek();
  redrawNtp();
}

function getTemperature(now) {
  if (temperature && temperature.at > now - 120) {
    return temperature.temp;
  }
  return null;
}

function dt(secs) {
  return new Date(secs * 1000)
}

function setRate(which, rate) {
  $('#' + which).text(sprintf("%.1f", rate));
  $('#' + which + 'secs').text(sprintf("%.1f", rate * 86400 / 1000000));

}

function handleResponse( result ) {
      if (result.temp) {
        temperature = result;
        $('#temp').text(sprintf("%.1f", temperature.temp));
      }
      if (result.rate) {
        $('#rate').text(sprintf("%.1f", rateInPpm(result.rate)));
        chartDataNtp.addRow([dt(result.at), rateInPpm(result.rate)]);
        while (chartDataNtp.getNumberOfRows() > 2000) {
          chartDataNtp.removeRow(0);
        }
        redrawNtp();
      }
      if (result.stats) {
        $('#last').text('-');
        $('#minute').text('-');
        $('#hour').text('-');
        var now = result.stats.now;
        if (result.stats.last) {
          var value = (result.stats.last - 1) * 1000000;
          setRate('last', value);
          if (chartData) {
            if (now != last) {
              chartData.addRow([dt(now), value]);
              last = now;
              while (chartData.getNumberOfRows() > 2000) {
                chartData.removeRow(0);
              }
              redraw();
            }
          }
        }
        if (result.stats.minute) {
          var value = (result.stats.minute - 1) * 1000000;
          setRate('minute', value);
          if (chartDataHour) {
            sampleHour = sampleHour + 1;
            if (sampleHour % 30 == 0) {
              chartDataHour.addRow([dt(now), value]);
              lastHour = now;
              while (chartDataHour.getNumberOfRows() > 2000) {
                chartDataHour.removeRow(0);
              }
              redrawHour();
            }
          }
        }
        if (result.stats.hour) {
          var value = (result.stats.hour - 1) * 1000000;
          setRate('hour', value);
          if (chartDataWeek) {
            sampleWeek = sampleWeek + 1;
            if (sampleWeek % 300 == 0) {
              chartDataWeek.addRow([dt(now), value, getTemperature(now)]);
              lastWeek = now;
              while (chartDataWeek.getNumberOfRows() > 2000) {
                chartDataWeek.removeRow(0);
              }
              redrawWeek();
            }
          }
        }
      }
      if (result.history) {
        var now = result.history.now;
        if (result.history.minute) {
          if (chartData) {
            var arr = result.history.minute;
            last = now - 2 * arr.length;
            for (var i = 0; i < arr.length; i++) {
              last = last + 2;
              chartData.addRow([dt(last), (arr[i] - 1) * 1000000]);
            }
            redraw();
          }
        }
        if (result.history.hour) {
          if (chartDataHour) {
            var arr = result.history.hour;
            lastHour = now - 60 * arr.length;
            for (var i = 0; i < arr.length; i++) {
              lastHour = lastHour + 60;
              chartDataHour.addRow([dt(lastHour), (arr[i] - 1) * 1000000]);
            }
            redrawHour();
          }
        }
      }
}

function addToWeek(data) {
  chartDataWeek.addRow([dt(data.at), (data.rate - 1) * 1000000, data.temp]);
}

function addToNtp(data) {
  chartDataNtp.addRow([dt(data.at), rateInPpm(data.rate)]);
}

function loadNtp(next) {
  $.ajax({
    url: "/ntp",
    dataType: "text",
  }).done(function (data) {
    var lines = data.split("\n");
    for (var i = 0; i < lines.length; i++) {
      try {
        addToNtp(JSON.parse(lines[i]));
      } catch (e) {
        console.log("Failed to parse '" + lines[i] + "'");
      }
    }
    redrawNtp();
    next();
  });
}

function loadHistory(next) {
  $.ajax({
    url: "/history",
    dataType: "text",
  }).done(function (data) {
    var lines = data.split("\n");
    for (var i = 0; i < lines.length; i++) {
      try {
        addToWeek(JSON.parse(lines[i]));
      } catch (e) {
        console.log("Failed to parse '" + lines[i] + "'");
      }
    }
    redrawWeek();
    next();
  });
}

var timeout_close;
var timeout_error;

function refresh() {
    var ws = new WebSocket("ws://" + window.location.host + "/data");
    ws.onmessage = function(event) {
      handleResponse(JSON.parse(event.data));
    };
    ws.onerror = function() {
      ws.onerror = null;
      ws.onclose = null;
      ws.close();
      timeout_error = window.setTimeout(refresh, 5000);
    };
    ws.onclose = function() {
      ws.onerror = null;
      ws.onclose = null;
      ws.close();
      timeout_close = window.setTimeout(refresh, 5000);
    };
}

function drawChart() {
        var data = new google.visualization.DataTable();
        data.addColumn('datetime', 'Date');
        data.addColumn('number', 'Tick');

        chart = new google.visualization.LineChart(document.getElementById('minute_chart'));
        chartData = data;
        redraw();

        data = new google.visualization.DataTable();
        data.addColumn('datetime', 'Date');
        data.addColumn('number', 'Tick');

        chartHour = new google.visualization.LineChart(document.getElementById('hour_chart'));
        chartDataHour = data;
        redrawHour();

        data = new google.visualization.DataTable();
        data.addColumn('datetime', 'Date');
        data.addColumn('number', 'Tick');
        data.addColumn('number', 'Temperature');

        chartWeek = new google.visualization.LineChart(document.getElementById('week_chart'));
        chartDataWeek = data;
        redrawWeek();

        data = new google.visualization.DataTable();
        data.addColumn('datetime', 'Date');
        data.addColumn('number', 'Rate');

        chartNtp = new google.visualization.LineChart(document.getElementById('ntp_chart'));
        chartDataNtp = data;
        redrawNtp();
}

function startup() {
  drawChart();
  loadNtp(function() { loadHistory(refresh) } );
}

$(document).ready(function() {
  google.charts.load('upcoming', {packages: ['corechart', 'line']});
  google.charts.setOnLoadCallback(startup);
});
</script>
</body></html>
