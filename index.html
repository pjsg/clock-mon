<html><head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sprintf/1.1.2/sprintf.min.js"></script>
<style>
body {
  font-family: sans-serif;
}
.led {
    height: 25px;
    width: 25px;
    background-color: #fff;
    border-radius: 50%;
    display: inline-block;
    vertical-align: middle;
}

#display {
    border: 1px solid;
    vertical-align: middle;
}
input.narrow {
  width: 12em;
}
</style>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head><body>
<h1>Clock rate</h1>

<br>
<table>
<tr><td>Instantaneous&nbsp;</td><td align=right><span id='last'></span></td></tr>
<tr><td>Minute</td><td align=right><span id='minute'></span></td></tr>
<tr><td>Hour</td><td align=right><span id='hour'></span></td></tr>
</table>
<div id="minute_chart" style="height:400px"></div>
<div id="hour_chart" style="height: 400px"></div>
<div id="week_chart" style="height: 400px"></div>
<script>

function leftFillNum(num, width){
  return num
    .toString()
    .padStart(width,0)
}

var chartWeek;
var chartDataWeek;
var sampleWeek = 0;
var chartHour;
var chartDataHour;
var sampleHour = 0;
var chart;
var chartData;
var sample = 0;

function redrawWeek() {
        var options = {
          hAxis: {
            title: 'Time (hours)'
          },
          vAxis: {
            title: 'Tick period'
          },
          backgroundColor: '#f1f8e9'
        };

  chartWeek.draw(chartDataWeek, options);
}

function redrawHour() {
        var options = {
          hAxis: {
            title: 'Time (minutes)'
          },
          vAxis: {
            title: 'Tick period'
          },
          backgroundColor: '#f1f8e9'
        };

  chartHour.draw(chartDataHour, options);
}

function redraw() {
        var options = {
          hAxis: {
            title: 'Time (ticks -- 2 seconds)'
          },
          vAxis: {
            title: 'Tick period'
          },
          backgroundColor: '#f1f8e9'
        };

  chart.draw(chartData, options);
}

function handleResponse( result ) {
      if (result.stats) {
        $('#last').text('-');
        $('#minute').text('-');
        $('#hour').text('-');
        if (result.stats.last) {
          $('#last').text(sprintf("%.6f", result.stats.last));
          if (chartData) {
            chartData.addRow([sample, result.stats.last]);
            sample = sample + 1;
            while (chartData.getNumberOfRows() > 1000) {
              chartData.removeRow(0);
            }
            redraw();
          }
        }
        if (result.stats.minute) {
          $('#minute').text(sprintf("%.6f", result.stats.minute));
          if (chartDataHour) {
            if (sample % 30 == 0) {
              chartDataHour.addRow([sampleHour, result.stats.minute]);
              sampleHour = sampleHour + 1;
              while (chartDataHour.getNumberOfRows() > 1000) {
                chartDataHour.removeRow(0);
              }
              redrawHour();
            }
          }
        }
        if (result.stats.hour) {
          $('#hour').text(sprintf("%.6f", result.stats.hour));
          if (chartDataWeek) {
            if (sampleHour % 60 == 0) {
              chartDataWeek.addRow([sampleWeek, result.stats.hour]);
              sampleWeek = sampleWeek + 1;
              while (chartDataWeek.getNumberOfRows() > 1000) {
                chartDataWeek.removeRow(0);
              }
              redrawWeek();
            }
          }
        }
      }
      if (result.history) {
        if (result.history.minute) {
          if (chartData) {
            var arr = result.history.minute;
            for (var i = 0; i < arr.length; i++) {
              chartData.addRow([sample, arr[i]]);
              sample = sample + 1;
            }
            redraw();
          }
        }
        if (result.history.hour) {
          if (chartDataHour) {
            var arr = result.history.hour;
            for (var i = 0; i < arr.length; i++) {
              chartDataHour.addRow([sampleHour, arr[i]]);
              sampleHour = sampleHour + 1;
            }
            redrawHour();
          }
        }
        if (result.history.week) {
          if (chartDataWeek) {
            var arr = result.history.week;
            for (var i = 0; i < arr.length; i++) {
              chartDataWeek.addRow([sampleWeek, arr[i]]);
              sampleWeek = sampleWeek + 1;
            }
            redrawWeek();
          }
        }
      }
}

var timeout_close;
var timeout_error;

function refresh() {
    var ws = new WebSocket("ws://" + window.location.host + "/data");
    ws.onmessage = function(event) {
      handleResponse(JSON.parse(event.data));
    };
    ws.onerror = function() {
      timeout_error = window.setTimeout(refresh, 5000);
    };
    ws.onclose = function() {
      timeout_close = window.setTimeout(refresh, 5000);
    };
}

function drawChart() {
        var data = new google.visualization.DataTable();
        data.addColumn('number', 'Sample');
        data.addColumn('number', 'Tick');

        chart = new google.visualization.LineChart(document.getElementById('minute_chart'));
        chartData = data;
        redraw();

        data = new google.visualization.DataTable();
        data.addColumn('number', 'Sample');
        data.addColumn('number', 'Tick');

        chartHour = new google.visualization.LineChart(document.getElementById('hour_chart'));
        chartDataHour = data;
        redrawHour();

        data = new google.visualization.DataTable();
        data.addColumn('number', 'Sample');
        data.addColumn('number', 'Tick');

        chartWeek = new google.visualization.LineChart(document.getElementById('week_chart'));
        chartDataWeek = data;
        redrawWeek();
}

function startup() {
  drawChart();
  refresh();
}

$(document).ready(function() {
  google.charts.load('current', {packages: ['corechart', 'line']});
  google.charts.setOnLoadCallback(startup);
});
</script>
</body></html>
