<html><head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sprintf/1.1.2/sprintf.min.js"></script>
<style>
body {
  font-family: sans-serif;
}
.led {
    height: 25px;
    width: 25px;
    background-color: #fff;
    border-radius: 50%;
    display: inline-block;
    vertical-align: middle;
}

#display {
    border: 1px solid;
    vertical-align: middle;
}
input.narrow {
  width: 12em;
}
</style>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head><body>
<h1>Clock rate</h1>

<br>
<table>
<tr><td>Instantaneous&nbsp;</td><td align=right><span id='last'></span></td><td>ppm</td></tr>
<tr><td>Minute</td><td align=right><span id='minute'></span></td><td>ppm</td></tr>
<tr><td>Hour</td><td align=right><span id='hour'></span></td><td>ppm</td></tr>
</table>
<div id="minute_chart" style="height:400px; width:100%"></div>
<div id="hour_chart" style="height: 400px; width:100%"></div>
<div id="week_chart" style="height: 400px; width:100%"></div>
<script>

function leftFillNum(num, width){
  return num
    .toString()
    .padStart(width,0)
}

var chartWeek;
var chartDataWeek;
var lastWeek = 0;
var sampleWeek = 0;
var chartHour;
var chartDataHour;
var lastHour = 0;
var sampleHour = 0;
var chart;
var chartData;
var last = 0;

function redrawWeek() {
        var options = {
          hAxis: {
            title: 'Time'
          },
          vAxis: {
            title: 'Tick error (ppm)'
          },
          backgroundColor: '#f1f8e9'
        };

  if (chartDataWeek.getNumberOfRows() > 0) {
    chartWeek.clearChart();
    chartWeek.draw(chartDataWeek, options);
  }
}

function redrawHour() {
        var options = {
          hAxis: {
            title: 'Time'
          },
          vAxis: {
            title: 'Tick error (ppm)'
          },
          backgroundColor: '#f1f8e9'
        };

  if (chartDataHour.getNumberOfRows() > 0) {
    chartHour.clearChart();
    chartHour.draw(chartDataHour, options);
  }
}

function redraw() {
        var options = {
          hAxis: {
            title: 'Time'
          },
          vAxis: {
            title: 'Tick error (ppm)'
          },
          backgroundColor: '#f1f8e9'
        };

  if (chartData.getNumberOfRows() > 0) {
    chart.clearChart();
    chart.draw(chartData, options);
  }
}

window.onresize = function() {
  redraw();
  redrawHour();
  redrawWeek();
}


function dt(secs) {
  return new Date(secs * 1000)
}

function handleResponse( result ) {
      if (result.stats) {
        $('#last').text('-');
        $('#minute').text('-');
        $('#hour').text('-');
        var now = result.stats.now;
        if (result.stats.last) {
          var value = (result.stats.last - 1) * 1000000;
          $('#last').text(sprintf("%.1f", value));
          if (chartData) {
            if (now != last) {
              chartData.addRow([dt(now), value]);
              last = now;
              while (chartData.getNumberOfRows() > 2000) {
                chartData.removeRow(0);
              }
              redraw();
            }
          }
        }
        if (result.stats.minute) {
          var value = (result.stats.minute - 1) * 1000000;
          $('#minute').text(sprintf("%.1f", value));
          if (chartDataHour) {
            sampleHour = sampleHour + 1;
            if (sampleHour % 30 == 0) {
              chartDataHour.addRow([dt(now), value]);
              lastHour = now;
              while (chartDataHour.getNumberOfRows() > 2000) {
                chartDataHour.removeRow(0);
              }
              redrawHour();
            }
          }
        }
        if (result.stats.hour) {
          var value = (result.stats.hour - 1) * 1000000;
          $('#hour').text(sprintf("%.1f", value));
          if (chartDataWeek) {
            sampleWeek = sampleWeek + 1;
            if (sampleWeek % 300 == 0) {
              chartDataWeek.addRow([dt(now), value]);
              lastWeek = now;
              while (chartDataWeek.getNumberOfRows() > 2000) {
                chartDataWeek.removeRow(0);
              }
              redrawWeek();
            }
          }
        }
      }
      if (result.history) {
        var now = result.history.now;
        if (result.history.minute) {
          if (chartData) {
            var arr = result.history.minute;
            last = now - 2 * arr.length;
            for (var i = 0; i < arr.length; i++) {
              last = last + 2;
              chartData.addRow([dt(last), (arr[i] - 1) * 1000000]);
            }
            redraw();
          }
        }
        if (result.history.hour) {
          if (chartDataHour) {
            var arr = result.history.hour;
            lastHour = now - 60 * arr.length;
            for (var i = 0; i < arr.length; i++) {
              lastHour = lastHour + 60;
              chartDataHour.addRow([dt(lastHour), (arr[i] - 1) * 1000000]);
            }
            redrawHour();
          }
        }
      }
}

function addToWeek(data) {
  chartDataWeek.addRow([dt(data.at), (data.rate - 1) * 1000000]);
}

function loadHistory(next) {
  $.ajax({
    url: "/history",
    dataType: "text",
  }).done(function (data) {
    var lines = data.split("\n");
    for (var i = 0; i < lines.length; i++) {
      try {
        addToWeek(JSON.parse(lines[i]));
      } catch (e) {
        console.log("Failed to parse '" + lines[i] + "'");
      }
    }
    next();
  });
}

var timeout_close;
var timeout_error;

function refresh() {
    var ws = new WebSocket("ws://" + window.location.host + "/data");
    ws.onmessage = function(event) {
      handleResponse(JSON.parse(event.data));
    };
    ws.onerror = function() {
      ws.onerror = null;
      ws.onclose = null;
      ws.close();
      timeout_error = window.setTimeout(refresh, 5000);
    };
    ws.onclose = function() {
      ws.onerror = null;
      ws.onclose = null;
      ws.close();
      timeout_close = window.setTimeout(refresh, 5000);
    };
}

function drawChart() {
        var data = new google.visualization.DataTable();
        data.addColumn('datetime', 'Date');
        data.addColumn('number', 'Tick');

        chart = new google.visualization.LineChart(document.getElementById('minute_chart'));
        chartData = data;
        redraw();

        data = new google.visualization.DataTable();
        data.addColumn('datetime', 'Date');
        data.addColumn('number', 'Tick');

        chartHour = new google.visualization.LineChart(document.getElementById('hour_chart'));
        chartDataHour = data;
        redrawHour();

        data = new google.visualization.DataTable();
        data.addColumn('datetime', 'Date');
        data.addColumn('number', 'Tick');

        chartWeek = new google.visualization.LineChart(document.getElementById('week_chart'));
        chartDataWeek = data;
        redrawWeek();
}

function startup() {
  drawChart();
  loadHistory(refresh);
}

$(document).ready(function() {
  google.charts.load('upcoming', {packages: ['corechart', 'line']});
  google.charts.setOnLoadCallback(startup);
});
</script>
</body></html>
